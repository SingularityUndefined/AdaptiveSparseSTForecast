# Discussion Dec 29

## 1 GEM Framework

Energy constraint: $\Vert \mathbf{L}\Vert_F^2=\sum_{i\in\mathcal{V}} d_i+2\sum_{(i,j)\in\mathcal{E}}w_{ij}^2=c^2$.

Notations: edge weights of all potential edges $\mathbf{W}^o$, actual weight matrix $\mathbf{W}=\mathbf{W}^o\circ \mathbf{A}$, corresponding Laplacian matrix $\mathbf{L}=\text{diag}(\mathbf{W1})-\mathbf{W}$ 

![](C:\Users\qij21\Desktop\GEM_framework.png)

### 1.1 E step

1. Solve the following equation by CG:
   $$
   (\mathbf{I}+\mu\mathbf{L})\mathbf{x}=\mathbf{y}
   $$

2. Regenerate the graph based on new $\mathbf{x}$: 
   $$
   {\mathbf{W}^o}' = \texttt{UGL}(\mathbf{x}; \Theta), \quad \mathbf{W}'={\mathbf{W}^o}'\circ \mathbf{A},\quad \mathbf{L}'=\text{diag}(\mathbf{W'1})-\mathbf{W}'
   $$

3. Rescale to $\Vert \mathbf{L}'\Vert_F^2=c^2$ (PGD under sphere constraint)

### 1.2 M1 step

$$
\min \mathcal{L}_1(\Theta) =\frac{1}{N} \sum_{k=1}^N\mathbf{x}^{(k)\top}\mathbf{L'}\mathbf{x}^{(k)} - \log|\mathbf{L'}|
$$

1. Compute proxy loss: **detach** $\mathbf{R}=(\mathbf{L'}+\mathbf{J})^{-1}=\mathbf{L'}^\dagger+\mathbf{J}$,
   $$
   \tilde{\mathcal{L}}_1(\Theta) = \text{tr}(\mathbf{SL'}) - \text{tr}(\mathbf{R}\mathbf{L'})=\sum_{(i,j)\in\mathcal{E}}w'_{ij} \frac{1}{N} \sum_{k=1}^N (x_i^{(k)}-x_j^{(k)})^2 - \sum_{(i,j)\in\mathcal{E}}w'_{i,j}(\mathbf{e}_i-\mathbf{e}_j)^\top\mathbf{R}(\mathbf{e}_i-\mathbf{e}_j)
   $$

2. Gradient step:
   $$
   \Theta^{\text{new}}=\Theta - \delta\nabla \tilde{\mathcal{L}}(\Theta)
   $$

3. Regenerate the graph based on the new $\Theta^{\text{new}}$
   $$
   {\mathbf{W}^o}^\text{new} = \texttt{UGL}(\mathbf{x}; \Theta^\text{new}), \quad \mathbf{W}^\text{new}={\mathbf{W}^o}^\text{new}\circ \mathbf{A},\quad \mathbf{L}^\text{new}=\text{diag}(\mathbf{W^{\text{new}}1})-\mathbf{W}^\text{new}
   $$

4. Rescale (PGD under sphere constraint)

### 1.3 M2 step

$$
\min\mathcal{L}_2(\mathbf{A}) =\frac{1}{N} \sum_{k=1}^N\mathbf{x}^{(k)\top}\mathbf{L}\mathbf{x}^{(k)} - \log|\mathbf{L}|+\gamma\Vert \mathbf{A}\Vert_{1, \text{off}},\quad \mathbf{W}:={\mathbf{W}^o}^\text{new}\circ \mathbf{A},\ \mathbf{L}:=\text{diag}(\mathbf{W1})-\mathbf{W}
$$

PGD solution (upper-right only)
$$
\mathbf{A}^\text{new} = \Pi_{[0,1]^{N\times N}} \circ S_{\eta\gamma}\left(\mathbf{A} -\eta {\mathbf{W}^o}^\text{new}(\tilde{\mathbf{S}}-\tilde{\mathbf{R}})\right), \quad \tilde{S}_{ij}=S_{ii}+S_{jj} -2S_{ij},\quad \tilde{R}_{ij}=R_{ii}+R_{jj}-2R_{ij}
$$
**Element-wise updating formula:** detach $\mathbf{R}=(\mathbf{L}^\text{new}+\mathbf{J})^{-1}=\mathbf{L}^{\text{new}\dagger}+\mathbf{J}$, for each $(i,j)\in\mathcal{E}$,
$$
A_{ij}=\Pi_{[0,1]}\circ S_{\eta\gamma}\left(A_{ij} - {\eta} {W^o}^\text{new}_{ij}\left(\frac{1}{N}\sum_{k=1}^N (x_i^{(k)}-x_j^{(k)})^2 - (\mathbf{e}_i-\mathbf{e}_j)^\top \mathbf{R}(\mathbf{e}_i-\mathbf{e}_j)\right) \right)
$$

## 2 Implementation

### 2.0 Sparse setup

- Real graph: $5\times 5$ grid
- Guessed graph: 8-neighbor graph (with diagonal connection) (kernel size $3\times 3$)
- kNN neighbor list `(N, k)`.

![image-20251229142611937](C:\Users\qij21\AppData\Roaming\Typora\typora-user-images\image-20251229142611937.png)

### 2.1 E step

compute CG

### 2.2 M step---Compute $(\mathbf{e}_i-\mathbf{e}_j)^\top\mathbf{R}(\mathbf{e}_i-\mathbf{e}_j)$ for each $(i,j)\in\mathcal{E}$

#### *Methods*

**Method 1 (Reference point)**  Fix a reference point $r$, compute $(\mathbf{L}+\mathbf{J})^{-1}(\mathbf{e}_i-\mathbf{e}_r)$ for each $i$. $\mathbf{R}(\mathbf{e}_i-\mathbf{e}_j)=\mathbf{R}(\mathbf{e}_i-\mathbf{e}_r) - \mathbf{R}(\mathbf{e}_j-\mathbf{e}_r)$

**Advantage:** Solving $n-1$ linear equations in total. 

Memory cost: host $(n-1)\times n$ matrix for solutions of $\mathbf{R}(\mathbf{e}_i-\mathbf{e}_r)$, in-place operation to compute $\tilde{R}$

Examination: $\text{tr}(\mathbf{RL})=n-1=\sum_{(i,j)\in \mathcal{E}} W_{ij}^o A_{ij} (R_{ii}+R_{jj}-2R_{ij})$

***Problem:*** residual for batch CG is large: 5 iterations $10^{-1}$, 10 iterations $5\times 10^{-3}$

#### Alternative: *Preconditioned CG*

Key problem: the *condition number*?

Use normalized Laplacian matrix: $\mathbf{L}_n=\mathbf{D}^{-1/2}\mathbf{L}\mathbf{D}^{-1/2}$. The eigenvalues are restricted to [0,2]

**Precondition matrix** $\mathbf{M}=\mathbf{D}+\mathbf{J}=\mathbf{D}+\frac{1}{n}\mathbf{11}^\top$

Sherman-Morrison:
$$
\mathbf{M}^{-1} = \mathbf{D}^{-1} - \frac{\frac{1}{n}\mathbf{D}^{-1}\mathbf{11}^\top\mathbf{D}^{-1}}{1 +\frac{1}{n} \mathbf{1}^\top\mathbf{D}^{-1}\mathbf{1}}, \quad (\mathbf{M}^{-1})_{ij} = d_{ij}^{-1} - \frac{d_i^{-1}d_j^{-1}}{n + \sum_i d_{ii}^{-1}},\ \mathbf{M}^{-1} = \text{diag}(\mathbf{d}^{-1}) - \frac{\mathbf{d}^{-1}(\mathbf{d}^{-1})^\top}{n + \mathbf{1}^\top \mathbf{d}^{-1}}\\
(\mathbf{M}^{-1}\mathbf{r})_{i} = \frac{r_i}{d_i} - \frac{\sum_{j}\frac{r_j}{d_id_j}}{n + \sum_i\frac{1}{d_{ii}}}= d_i^{-1}(r_i - \frac{\sum_j r_j d_j^{-1}}{n+\sum_i d_i^{-1}}), \quad \mathbf{M}^{-1}\mathbf{r} = \mathbf{u}\circ \mathbf{r} - \frac{\mathbf{u}^\top \mathbf{r}}{n+\mathbf{1}^\top \mathbf{u}} \mathbf{u}
$$
***Results:*** 5 iterations $5\times 10^{-2}$,  10 iterations $1\times 10^{-3}$



## 3 Experiments

















> #### *Solution 1:* Using $(\mathbf{L}+\epsilon\mathbf{I})^{-1}$ instead of $(\mathbf{L+J})^{-1}$
>
> $$
> \mathbf{L}=\mathbf{P}\text{diag}(0,\lambda_2,\dots, \lambda_n)\mathbf{P}^\top, \mathbf{p}_1=\frac{1}{\sqrt{n}}\mathbf{1}\\
> (\mathbf{L}+\mathbf{J})^{-1} = \mathbf{L}^\dagger + \mathbf{J}\\
> (\mathbf{L}+\epsilon\mathbf{I})^{-1}=\mathbf{P}\text{diag}\left(\frac{1}{\epsilon},\frac{1}{\lambda_2+\epsilon},\dots, \frac{1}{\lambda_n+\epsilon}\right)\mathbf{P}^\top\approx \mathbf{L}^\dagger+\frac{1}{\epsilon}\mathbf{J}
> $$
>
> Approximation error:
> $$
> \mathbf{E}=(\mathbf{L}+\epsilon\mathbf{I})^{-1}-\frac{1}{\epsilon}\mathbf{J} - \mathbf{L}^\dagger = \mathbf{P}\text{diag}\left(0, -\frac{\epsilon}{\lambda_2(\lambda_2+\epsilon)}, \dots,-\frac{\epsilon}{\lambda_n(\lambda_n+\epsilon)}\right)\mathbf{P}^\top\\
> \Vert\mathbf{E}\Vert_2=\frac{\epsilon}{\lambda_2(\lambda_2+\epsilon)}\le \frac{\epsilon}{\lambda_2^2}
> $$
> Cheeger's inequality:
> $$
> \frac{h(G)^2}{2d_{\text{max}}}\le \lambda_2\le 2h(G),\quad h(G)=\min_{S\subset V, 0<|S|\le n/2}\frac{|\partial S|}{|S|}
> $$
> for a grid graph with $k\times k$ windowed neighbors, $d_{\text{max}}=k^2-1$. For a square region of $a\times b$, $|S|\approx ab\le n^2/2$, $|\partial S|\approx k^2+2(a+b)\frac{k}{2}$
> $$
> \frac{|\partial S|}{|S|}\approx \frac{k^2+(a+b)k}{ab}\ge \frac{k^2+2\sqrt{ab}k}{ab},\quad h(G)\approx \frac{2k^2}{n^2}+\frac{2kn/\sqrt{2}}{n^2/2}=\frac{2\sqrt{2}k}{n}+\frac{2k^2}{n^2} = (\frac{\sqrt 2 k}{n}+1)^2-1
> $$
> Thus, $\lambda_2^2\ge (\frac{h(G)^2}{2(k^2-1)})^2\ge\epsilon$.
>
> Estimate $\lambda_2 \ge \frac{1}{2\times 8}(\frac{6\sqrt 2}{5}+\frac{18}{25})\approx 0.21$, $\epsilon \approx 4\times 10^{-3}$



